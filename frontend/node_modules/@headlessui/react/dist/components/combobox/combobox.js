import z,{Fragment as Te,createContext as ue,createRef as xe,useCallback as ge,useContext as pe,useMemo as h,useReducer as Oe,useRef as E,useEffect as se}from"react";import{useComputed as oe}from'../../hooks/use-computed.js';import{useDisposables as ne}from'../../hooks/use-disposables.js';import{useEvent as x}from'../../hooks/use-event.js';import{useId as $}from'../../hooks/use-id.js';import{useIsoMorphicEffect as k}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ce}from'../../hooks/use-latest-value.js';import{useOutsideClick as Re}from'../../hooks/use-outside-click.js';import{useResolveButtonType as ve}from'../../hooks/use-resolve-button-type.js';import{useSyncRefs as J}from'../../hooks/use-sync-refs.js';import{useTreeWalker as ye}from'../../hooks/use-tree-walker.js';import{calculateActiveIndex as Se,Focus as y}from'../../utils/calculate-active-index.js';import{disposables as de}from'../../utils/disposables.js';import{forwardRefWithAs as U,render as G,compact as Ae,Features as be}from'../../utils/render.js';import{isDisabledReactIssue7711 as Pe}from'../../utils/bugs.js';import{match as N}from'../../utils/match.js';import{objectToFormEntries as Ee}from'../../utils/form.js';import{sortByDomNode as Ie}from'../../utils/focus-management.js';import{Hidden as Le,Features as De}from'../../internal/hidden.js';import{useOpenClosed as Ve,State as ee,OpenClosedProvider as Me}from'../../internal/open-closed.js';import{Keys as A}from'../keyboard.js';import{useControllable as he}from'../../hooks/use-controllable.js';import{useWatch as ce}from'../../hooks/use-watch.js';import{useTrackedPointer as Fe}from'../../hooks/use-tracked-pointer.js';import{isMobile as _e}from'../../utils/platform.js';var ke=(n=>(n[n.Open=0]="Open",n[n.Closed=1]="Closed",n))(ke||{}),we=(n=>(n[n.Single=0]="Single",n[n.Multi=1]="Multi",n))(we||{}),Be=(n=>(n[n.Pointer=0]="Pointer",n[n.Other=1]="Other",n))(Be||{}),Ue=(a=>(a[a.OpenCombobox=0]="OpenCombobox",a[a.CloseCombobox=1]="CloseCombobox",a[a.GoToOption=2]="GoToOption",a[a.RegisterOption=3]="RegisterOption",a[a.UnregisterOption=4]="UnregisterOption",a[a.RegisterLabel=5]="RegisterLabel",a))(Ue||{});function re(t,r=n=>n){let n=t.activeOptionIndex!==null?t.options[t.activeOptionIndex]:null,o=Ie(r(t.options.slice()),u=>u.dataRef.current.domRef.current),i=n?o.indexOf(n):null;return i===-1&&(i=null),{options:o,activeOptionIndex:i}}let Ge={[1](t){var r;return(r=t.dataRef.current)!=null&&r.disabled||t.comboboxState===1?t:{...t,activeOptionIndex:null,comboboxState:1}},[0](t){var n;if((n=t.dataRef.current)!=null&&n.disabled||t.comboboxState===0)return t;let r=t.activeOptionIndex;if(t.dataRef.current){let{isSelected:o}=t.dataRef.current,i=t.options.findIndex(u=>o(u.dataRef.current.value));i!==-1&&(r=i)}return{...t,comboboxState:0,activeOptionIndex:r}},[2](t,r){var i,u,a,p;if((i=t.dataRef.current)!=null&&i.disabled||((u=t.dataRef.current)==null?void 0:u.optionsRef.current)&&!((a=t.dataRef.current)!=null&&a.optionsPropsRef.current.static)&&t.comboboxState===1)return t;let n=re(t);if(n.activeOptionIndex===null){let c=n.options.findIndex(e=>!e.dataRef.current.disabled);c!==-1&&(n.activeOptionIndex=c)}let o=Se(r,{resolveItems:()=>n.options,resolveActiveIndex:()=>n.activeOptionIndex,resolveId:c=>c.id,resolveDisabled:c=>c.dataRef.current.disabled});return{...t,...n,activeOptionIndex:o,activationTrigger:(p=r.trigger)!=null?p:1}},[3]:(t,r)=>{var u,a;let n={id:r.id,dataRef:r.dataRef},o=re(t,p=>[...p,n]);t.activeOptionIndex===null&&(u=t.dataRef.current)!=null&&u.isSelected(r.dataRef.current.value)&&(o.activeOptionIndex=o.options.indexOf(n));let i={...t,...o,activationTrigger:1};return((a=t.dataRef.current)==null?void 0:a.__demoMode)&&t.dataRef.current.value===void 0&&(i.activeOptionIndex=0),i},[4]:(t,r)=>{let n=re(t,o=>{let i=o.findIndex(u=>u.id===r.id);return i!==-1&&o.splice(i,1),o});return{...t,...n,activationTrigger:1}},[5]:(t,r)=>({...t,labelId:r.id})},ae=ue(null);ae.displayName="ComboboxActionsContext";function q(t){let r=pe(ae);if(r===null){let n=new Error(`<${t} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(n,q),n}return r}let le=ue(null);le.displayName="ComboboxDataContext";function H(t){let r=pe(le);if(r===null){let n=new Error(`<${t} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(n,H),n}return r}function Ne(t,r){return N(r.type,Ge,t,r)}let He=Te;function je(t,r){let{value:n,defaultValue:o,onChange:i,name:u,by:a=(b,m)=>b===m,disabled:p=!1,__demoMode:c=!1,nullable:e=!1,multiple:s=!1,...P}=t,[d=s?[]:void 0,v]=he(n,i,o),[T,O]=Oe(Ne,{dataRef:xe(),comboboxState:c?0:1,options:[],activeOptionIndex:null,activationTrigger:1,labelId:null}),g=E(!1),R=E({static:!1,hold:!1}),j=E(null),F=E(null),w=E(null),B=E(null),D=x(typeof a=="string"?(b,m)=>{let S=a;return(b==null?void 0:b[S])===(m==null?void 0:m[S])}:a),K=ge(b=>N(f.mode,{[1]:()=>d.some(m=>D(m,b)),[0]:()=>D(d,b)}),[d]),f=h(()=>({...T,optionsPropsRef:R,labelRef:j,inputRef:F,buttonRef:w,optionsRef:B,value:d,defaultValue:o,disabled:p,mode:s?1:0,get activeOptionIndex(){if(g.current&&T.activeOptionIndex===null&&T.options.length>0){let b=T.options.findIndex(m=>!m.dataRef.current.disabled);if(b!==-1)return b}return T.activeOptionIndex},compare:D,isSelected:K,nullable:e,__demoMode:c}),[d,o,p,s,e,c,T]),V=E(f.activeOptionIndex!==null?f.options[f.activeOptionIndex]:null);se(()=>{let b=f.activeOptionIndex!==null?f.options[f.activeOptionIndex]:null;V.current!==b&&(V.current=b)}),k(()=>{T.dataRef.current=f},[f]),Re([f.buttonRef,f.inputRef,f.optionsRef],()=>te.closeCombobox(),f.comboboxState===0);let _=h(()=>({open:f.comboboxState===0,disabled:p,activeIndex:f.activeOptionIndex,activeOption:f.activeOptionIndex===null?null:f.options[f.activeOptionIndex].dataRef.current.value,value:d}),[f,p,d]),C=x(b=>{let m=f.options.find(S=>S.id===b);!m||M(m.dataRef.current.value)}),l=x(()=>{if(f.activeOptionIndex!==null){let{dataRef:b,id:m}=f.options[f.activeOptionIndex];M(b.current.value),te.goToOption(y.Specific,m)}}),L=x(()=>{O({type:0}),g.current=!0}),I=x(()=>{O({type:1}),g.current=!1}),W=x((b,m,S)=>(g.current=!1,b===y.Specific?O({type:2,focus:y.Specific,id:m,trigger:S}):O({type:2,focus:b,trigger:S}))),Q=x((b,m)=>(O({type:3,id:b,dataRef:m}),()=>{var S;((S=V.current)==null?void 0:S.id)===b&&(g.current=!0),O({type:4,id:b})})),Y=x(b=>(O({type:5,id:b}),()=>O({type:5,id:null}))),M=x(b=>N(f.mode,{[0](){return v==null?void 0:v(b)},[1](){let m=f.value.slice(),S=m.findIndex(X=>D(X,b));return S===-1?m.push(b):m.splice(S,1),v==null?void 0:v(m)}})),te=h(()=>({onChange:M,registerOption:Q,registerLabel:Y,goToOption:W,closeCombobox:I,openCombobox:L,selectActiveOption:l,selectOption:C}),[]),fe=r===null?{}:{ref:r},Z=E(null),me=ne();return se(()=>{!Z.current||o!==void 0&&me.addEventListener(Z.current,"reset",()=>{M(o)})},[Z,M]),z.createElement(ae.Provider,{value:te},z.createElement(le.Provider,{value:f},z.createElement(Me,{value:N(f.comboboxState,{[0]:ee.Open,[1]:ee.Closed})},u!=null&&d!=null&&Ee({[u]:d}).map(([b,m],S)=>z.createElement(Le,{features:De.Hidden,ref:S===0?X=>{var ie;Z.current=(ie=X==null?void 0:X.closest("form"))!=null?ie:null}:void 0,...Ae({key:b,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:b,value:m})})),G({ourProps:fe,theirProps:P,slot:_,defaultTag:He,name:"Combobox"}))))}let Ke=U(je),We="input",Xe=U(function(r,n){var f,V,_,C;let o=$(),{id:i=`headlessui-combobox-input-${o}`,onChange:u,displayValue:a,type:p="text",...c}=r,e=H("Combobox.Input"),s=q("Combobox.Input"),P=J(e.inputRef,n),d=E(!1),v=ne(),T=function(){var l;return typeof a=="function"&&e.value!==void 0?(l=a(e.value))!=null?l:"":typeof e.value=="string"?e.value:""}();ce(([l,L],[I,W])=>{d.current||!e.inputRef.current||(W===0&&L===1||l!==I)&&(e.inputRef.current.value=l)},[T,e.comboboxState]),ce(([l],[L])=>{if(l===0&&L===1){let I=e.inputRef.current;if(!I)return;let W=I.value,{selectionStart:Q,selectionEnd:Y,selectionDirection:M}=I;I.value="",I.value=W,M!==null?I.setSelectionRange(Q,Y,M):I.setSelectionRange(Q,Y)}},[e.comboboxState]);let O=E(!1),g=x(()=>{O.current=!0}),R=x(()=>{setTimeout(()=>{O.current=!1})}),j=x(l=>{switch(d.current=!0,l.key){case A.Backspace:case A.Delete:if(e.mode!==0||!e.nullable)return;let L=l.currentTarget;v.requestAnimationFrame(()=>{L.value===""&&(s.onChange(null),e.optionsRef.current&&(e.optionsRef.current.scrollTop=0),s.goToOption(y.Nothing))});break;case A.Enter:if(d.current=!1,e.comboboxState!==0||O.current)return;if(l.preventDefault(),l.stopPropagation(),e.activeOptionIndex===null){s.closeCombobox();return}s.selectActiveOption(),e.mode===0&&s.closeCombobox();break;case A.ArrowDown:return d.current=!1,l.preventDefault(),l.stopPropagation(),N(e.comboboxState,{[0]:()=>{s.goToOption(y.Next)},[1]:()=>{s.openCombobox()}});case A.ArrowUp:return d.current=!1,l.preventDefault(),l.stopPropagation(),N(e.comboboxState,{[0]:()=>{s.goToOption(y.Previous)},[1]:()=>{s.openCombobox(),v.nextFrame(()=>{e.value||s.goToOption(y.Last)})}});case A.Home:if(l.shiftKey)break;return d.current=!1,l.preventDefault(),l.stopPropagation(),s.goToOption(y.First);case A.PageUp:return d.current=!1,l.preventDefault(),l.stopPropagation(),s.goToOption(y.First);case A.End:if(l.shiftKey)break;return d.current=!1,l.preventDefault(),l.stopPropagation(),s.goToOption(y.Last);case A.PageDown:return d.current=!1,l.preventDefault(),l.stopPropagation(),s.goToOption(y.Last);case A.Escape:return d.current=!1,e.comboboxState!==0?void 0:(l.preventDefault(),e.optionsRef.current&&!e.optionsPropsRef.current.static&&l.stopPropagation(),s.closeCombobox());case A.Tab:if(d.current=!1,e.comboboxState!==0)return;e.mode===0&&s.selectActiveOption(),s.closeCombobox();break}}),F=x(l=>{s.openCombobox(),u==null||u(l)}),w=x(()=>{d.current=!1}),B=oe(()=>{if(!!e.labelId)return[e.labelId].join(" ")},[e.labelId]),D=h(()=>({open:e.comboboxState===0,disabled:e.disabled}),[e]),K={ref:P,id:i,role:"combobox",type:p,"aria-controls":(f=e.optionsRef.current)==null?void 0:f.id,"aria-expanded":e.disabled?void 0:e.comboboxState===0,"aria-activedescendant":e.activeOptionIndex===null||(V=e.options[e.activeOptionIndex])==null?void 0:V.id,"aria-labelledby":B,"aria-autocomplete":"list",defaultValue:(C=(_=r.defaultValue)!=null?_:e.defaultValue!==void 0?a==null?void 0:a(e.defaultValue):null)!=null?C:e.defaultValue,disabled:e.disabled,onCompositionStart:g,onCompositionEnd:R,onKeyDown:j,onChange:F,onBlur:w};return G({ourProps:K,theirProps:c,slot:D,defaultTag:We,name:"Combobox.Input"})}),$e="button",Je=U(function(r,n){var O;let o=H("Combobox.Button"),i=q("Combobox.Button"),u=J(o.buttonRef,n),a=$(),{id:p=`headlessui-combobox-button-${a}`,...c}=r,e=ne(),s=x(g=>{switch(g.key){case A.ArrowDown:return g.preventDefault(),g.stopPropagation(),o.comboboxState===1&&i.openCombobox(),e.nextFrame(()=>{var R;return(R=o.inputRef.current)==null?void 0:R.focus({preventScroll:!0})});case A.ArrowUp:return g.preventDefault(),g.stopPropagation(),o.comboboxState===1&&(i.openCombobox(),e.nextFrame(()=>{o.value||i.goToOption(y.Last)})),e.nextFrame(()=>{var R;return(R=o.inputRef.current)==null?void 0:R.focus({preventScroll:!0})});case A.Escape:return o.comboboxState!==0?void 0:(g.preventDefault(),o.optionsRef.current&&!o.optionsPropsRef.current.static&&g.stopPropagation(),i.closeCombobox(),e.nextFrame(()=>{var R;return(R=o.inputRef.current)==null?void 0:R.focus({preventScroll:!0})}));default:return}}),P=x(g=>{if(Pe(g.currentTarget))return g.preventDefault();o.comboboxState===0?i.closeCombobox():(g.preventDefault(),i.openCombobox()),e.nextFrame(()=>{var R;return(R=o.inputRef.current)==null?void 0:R.focus({preventScroll:!0})})}),d=oe(()=>{if(!!o.labelId)return[o.labelId,p].join(" ")},[o.labelId,p]),v=h(()=>({open:o.comboboxState===0,disabled:o.disabled,value:o.value}),[o]),T={ref:u,id:p,type:ve(r,o.buttonRef),tabIndex:-1,"aria-haspopup":"listbox","aria-controls":(O=o.optionsRef.current)==null?void 0:O.id,"aria-expanded":o.disabled?void 0:o.comboboxState===0,"aria-labelledby":d,disabled:o.disabled,onClick:P,onKeyDown:s};return G({ourProps:T,theirProps:c,slot:v,defaultTag:$e,name:"Combobox.Button"})}),qe="label",Qe=U(function(r,n){let o=$(),{id:i=`headlessui-combobox-label-${o}`,...u}=r,a=H("Combobox.Label"),p=q("Combobox.Label"),c=J(a.labelRef,n);k(()=>p.registerLabel(i),[i]);let e=x(()=>{var d;return(d=a.inputRef.current)==null?void 0:d.focus({preventScroll:!0})}),s=h(()=>({open:a.comboboxState===0,disabled:a.disabled}),[a]);return G({ourProps:{ref:c,id:i,onClick:e},theirProps:u,slot:s,defaultTag:qe,name:"Combobox.Label"})}),Ye="ul",Ze=be.RenderStrategy|be.Static,ze=U(function(r,n){let o=$(),{id:i=`headlessui-combobox-options-${o}`,hold:u=!1,...a}=r,p=H("Combobox.Options"),c=J(p.optionsRef,n),e=Ve(),s=(()=>e!==null?(e&ee.Open)===ee.Open:p.comboboxState===0)();k(()=>{var T;p.optionsPropsRef.current.static=(T=r.static)!=null?T:!1},[p.optionsPropsRef,r.static]),k(()=>{p.optionsPropsRef.current.hold=u},[p.optionsPropsRef,u]),ye({container:p.optionsRef.current,enabled:p.comboboxState===0,accept(T){return T.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:T.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(T){T.setAttribute("role","none")}});let P=oe(()=>{var T,O;return(O=p.labelId)!=null?O:(T=p.buttonRef.current)==null?void 0:T.id},[p.labelId,p.buttonRef.current]),d=h(()=>({open:p.comboboxState===0}),[p]),v={"aria-labelledby":P,role:"listbox","aria-multiselectable":p.mode===1?!0:void 0,id:i,ref:c};return G({ourProps:v,theirProps:a,slot:d,defaultTag:Ye,features:Ze,visible:s,name:"Combobox.Options"})}),et="li",tt=U(function(r,n){var V,_;let o=$(),{id:i=`headlessui-combobox-option-${o}`,disabled:u=!1,value:a,...p}=r,c=H("Combobox.Option"),e=q("Combobox.Option"),s=c.activeOptionIndex!==null?c.options[c.activeOptionIndex].id===i:!1,P=c.isSelected(a),d=E(null),v=Ce({disabled:u,value:a,domRef:d,textValue:(_=(V=d.current)==null?void 0:V.textContent)==null?void 0:_.toLowerCase()}),T=J(n,d),O=x(()=>e.selectOption(i));k(()=>e.registerOption(i,v),[v,i]);let g=E(!c.__demoMode);k(()=>{if(!c.__demoMode)return;let C=de();return C.requestAnimationFrame(()=>{g.current=!0}),C.dispose},[]),k(()=>{if(c.comboboxState!==0||!s||!g.current||c.activationTrigger===0)return;let C=de();return C.requestAnimationFrame(()=>{var l,L;(L=(l=d.current)==null?void 0:l.scrollIntoView)==null||L.call(l,{block:"nearest"})}),C.dispose},[d,s,c.comboboxState,c.activationTrigger,c.activeOptionIndex]);let R=x(C=>{if(u)return C.preventDefault();O(),c.mode===0&&e.closeCombobox(),_e()||requestAnimationFrame(()=>{var l;return(l=c.inputRef.current)==null?void 0:l.focus()})}),j=x(()=>{if(u)return e.goToOption(y.Nothing);e.goToOption(y.Specific,i)}),F=Fe(),w=x(C=>F.update(C)),B=x(C=>{!F.wasMoved(C)||u||s||e.goToOption(y.Specific,i,0)}),D=x(C=>{!F.wasMoved(C)||u||!s||c.optionsPropsRef.current.hold||e.goToOption(y.Nothing)}),K=h(()=>({active:s,selected:P,disabled:u}),[s,P,u]);return G({ourProps:{id:i,ref:T,role:"option",tabIndex:u===!0?void 0:-1,"aria-disabled":u===!0?!0:void 0,"aria-selected":P,disabled:void 0,onClick:R,onFocus:j,onPointerEnter:w,onMouseEnter:w,onPointerMove:B,onMouseMove:B,onPointerLeave:D,onMouseLeave:D},theirProps:p,slot:K,defaultTag:et,name:"Combobox.Option"})}),Bt=Object.assign(Ke,{Input:Xe,Button:Je,Label:Qe,Options:ze,Option:tt});export{Bt as Combobox};
